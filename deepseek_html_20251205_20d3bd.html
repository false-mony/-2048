<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA å…ƒæ•°æ® -->
    <meta name="theme-color" content="#007bff">
    <meta name="description" content="2048æ¸¸æˆ - æ»‘åŠ¨åˆå¹¶æ–¹å—ï¼ŒæŒ‘æˆ˜é«˜åˆ†ï¼æ”¯æŒæ™®é€šæ¨¡å¼å’Œå¤œé—´æ¨¡å¼ã€‚">
    <meta name="keywords" content="2048, æ¸¸æˆ, ç›Šæ™º, æ»‘åŠ¨, åˆå¹¶, æ–¹å—">
    <meta name="author" content="2048 Game">
    
    <!-- iOS PWA æ”¯æŒ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="2048æ¸¸æˆ">
    
    <!-- Windows PWA æ”¯æŒ -->
    <meta name="msapplication-TileColor" content="#007bff">
    <meta name="msapplication-TileImage" content="icons/icon-144x144.png">
    
    <title>2048æ¸¸æˆ - PWAç‰ˆ</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- åº”ç”¨å›¾æ ‡ -->
    <link rel="icon" href="icons/icon-192x192.png" type="image/png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <style>
        /* æ™®é€šæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ */
        :root {
            /* æ™®é€šæ¨¡å¼é¢œè‰²å˜é‡ */
            --primary-bg: #f8f9fa;
            --secondary-bg: #ffffff;
            --grid-bg: #e9ecef;
            --cell-bg: rgba(108, 117, 125, 0.1);
            --text-color: #212529;
            --accent-color: #007bff;
            --score-color: #dc3545;
            --button-bg: #6c757d;
            --button-hover: #5a6268;
            --restart-bg: #dc3545;
            --save-bg: #28a745;
            --load-bg: #17a2b8;
            --mode-toggle-bg: #ffc107;
            --success-color: #28a745;
            --error-color: #dc3545;
            --border-radius: 12px;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --modal-bg: #ffffff;
        }
        
        /* å¤œé—´æ¨¡å¼ */
        .night-mode {
            /* å¤œé—´æ¨¡å¼é¢œè‰²å˜é‡ */
            --primary-bg: #1a1a2e;
            --secondary-bg: #16213e;
            --grid-bg: #3a506b;
            --cell-bg: rgba(255, 255, 255, 0.05);
            --text-color: #ffffff;
            --accent-color: #ffd166;
            --score-color: #ffd166;
            --button-bg: #3a506b;
            --button-hover: #4a6280;
            --restart-bg: #ef8354;
            --save-bg: #1c7c54;
            --load-bg: #3498db;
            --mode-toggle-bg: #9b59b6;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --modal-bg: #16213e;
        }
        
        /* å®‰è£…æç¤ºæ ·å¼ */
        #install-prompt {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }
        
        #install-prompt.show {
            transform: translateY(0);
        }
        
        #install-prompt .prompt-content {
            flex: 1;
            text-align: left;
        }
        
        #install-prompt .prompt-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1rem;
        }
        
        #install-prompt .prompt-message {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        #install-prompt .prompt-actions {
            display: flex;
            gap: 10px;
        }
        
        #install-prompt .prompt-btn {
            background: white;
            color: #007bff;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        #install-prompt .prompt-btn:hover {
            background: #f8f9fa;
            transform: scale(1.05);
        }
        
        #install-prompt .prompt-btn.secondary {
            background: transparent;
            color: white;
            border: 1px solid white;
        }
        
        /* ç¦»çº¿æç¤º */
        #offline-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #ffc107;
            color: #212529;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* PWA å¯åŠ¨ç”»é¢æ ·å¼ */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .splash-logo {
            font-size: 3.5rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: bounce 1s ease infinite alternate;
        }
        
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }
        
        .splash-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .splash-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 123, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .splash-text {
            color: var(--text-color);
            opacity: 0.8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            position: relative;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        .container {
            width: 100%;
            height: 100%;
            max-width: 500px; /* æœ€å¤§å®½åº¦é™åˆ¶ */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding-top: max(15px, env(safe-area-inset-top));
            padding-bottom: max(15px, env(safe-area-inset-bottom));
        }
        
        /* é¡¶éƒ¨åŒºåŸŸ */
        .header {
            text-align: center;
            width: 100%;
            margin-bottom: 15px;
            position: relative;
        }
        
        .game-title {
            font-size: clamp(2.5rem, 8vw, 3.5rem);
            margin-bottom: 5px;
            color: var(--accent-color);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: color 0.3s ease;
        }
        
        .subtitle {
            font-size: clamp(0.9rem, 3vw, 1.1rem);
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 15px;
            transition: color 0.3s ease;
        }
        
        /* æ¨¡å¼åˆ‡æ¢æŒ‰é’® */
        .mode-toggle-container {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .mode-toggle {
            background-color: var(--mode-toggle-bg);
            color: var(--text-color);
            border: none;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: clamp(0.7rem, 2vw, 0.8rem);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        
        .mode-toggle:hover {
            transform: scale(1.05);
        }
        
        .mode-icon {
            font-size: 1rem;
        }
        
        .mode-label {
            font-weight: 600;
        }
        
        /* ç»Ÿè®¡ä¿¡æ¯åŒºåŸŸ */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .stat-box {
            background-color: var(--secondary-bg);
            border: 2px solid var(--grid-bg);
            border-radius: var(--border-radius);
            padding: 12px 10px;
            text-align: center;
            box-shadow: 0 4px 8px var(--shadow-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 80px;
            transition: all 0.3s ease;
        }
        
        .stat-title {
            font-size: clamp(0.8rem, 2.5vw, 0.95rem);
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 5px;
            white-space: nowrap;
            transition: color 0.3s ease;
        }
        
        .stat-value {
            font-size: clamp(1.5rem, 5vw, 1.8rem);
            font-weight: bold;
            color: var(--score-color);
            line-height: 1.2;
            transition: color 0.3s ease;
        }
        
        .merge-record {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-top: 4px;
            font-size: clamp(0.7rem, 2vw, 0.85rem);
        }
        
        .merge-highlight {
            color: var(--accent-color);
            font-weight: bold;
        }
        
        .merge-label {
            color: var(--text-color);
            opacity: 0.8;
        }
        
        /* æ¸¸æˆåŒºåŸŸ */
        .game-area {
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin: 10px 0;
        }
        
        .game-container {
            width: 100%;
            position: relative;
            aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢ */
            max-height: 65vh; /* æœ€å¤§é«˜åº¦é™åˆ¶ */
        }
        
        .grid-container {
            background-color: var(--grid-bg);
            border-radius: var(--border-radius);
            width: 100%;
            height: 100%;
            padding: 12px;
            box-shadow: 0 8px 16px var(--shadow-color);
            position: relative;
            transition: all 0.3s ease;
        }
        
        .grid {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .grid-inner {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 10px;
        }
        
        .grid-cell {
            background-color: var(--cell-bg);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease;
        }
        
        .tile-container {
            position: absolute;
            top: 12px;
            left: 12px;
            right: 12px;
            bottom: 12px;
            z-index: 2;
        }
        
        .tile {
            position: absolute;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            transition: all 0.12s ease-out, background-color 0.3s ease, color 0.3s ease;
            z-index: 10;
            user-select: none;
            overflow: hidden;
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        
        .tile-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            text-align: center;
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            line-height: 1;
            font-weight: bold;
        }
        
        .tile-new {
            animation: appear 0.2s ease-out;
        }
        
        .tile-merged {
            animation: pop 0.25s ease-out;
        }
        
        @keyframes appear {
            0% { opacity: 0; transform: scale(0.5); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        
        /* æ–¹å—é¢œè‰² - æ™®é€šæ¨¡å¼ */
        .tile-2 { background-color: #e9ecef; color: #495057; }
        .tile-4 { background-color: #dee2e6; color: #495057; }
        .tile-8 { background-color: #adb5bd; color: #ffffff; }
        .tile-16 { background-color: #6c757d; color: #ffffff; }
        .tile-32 { background-color: #007bff; color: #ffffff; }
        .tile-64 { background-color: #0056b3; color: #ffffff; }
        .tile-128 { background-color: #28a745; color: #ffffff; }
        .tile-256 { background-color: #20c997; color: #ffffff; }
        .tile-512 { background-color: #ffc107; color: #212529; }
        .tile-1024 { background-color: #fd7e14; color: #ffffff; }
        .tile-2048 { background-color: #dc3545; color: #ffffff; }
        .tile-4096 { background-color: #6f42c1; color: #ffffff; }
        .tile-8192 { background-color: #e83e8c; color: #ffffff; }
        
        /* å¤œé—´æ¨¡å¼ä¸‹çš„æ–¹å—é¢œè‰² */
        .night-mode .tile-2 { background-color: #3a506b; color: #fff; }
        .night-mode .tile-4 { background-color: #1c7c54; color: #fff; }
        .night-mode .tile-8 { background-color: #ef8354; color: #fff; }
        .night-mode .tile-16 { background-color: #e74c3c; color: #fff; }
        .night-mode .tile-32 { background-color: #9b59b6; color: #fff; }
        .night-mode .tile-64 { background-color: #3498db; color: #fff; }
        .night-mode .tile-128 { background-color: #1abc9c; color: #fff; }
        .night-mode .tile-256 { background-color: #f1c40f; color: #333; }
        .night-mode .tile-512 { background-color: #e67e22; color: #fff; }
        .night-mode .tile-1024 { background-color: #c0392b; color: #fff; }
        .night-mode .tile-2048 { background-color: #ffd166; color: #333; }
        .night-mode .tile-4096 { background-color: #8e44ad; color: #fff; }
        .night-mode .tile-8192 { background-color: #2c3e50; color: #fff; }
        
        /* æ–¹å—å­—ä½“é€‚é… */
        .tile-128 .tile-number,
        .tile-256 .tile-number,
        .tile-512 .tile-number {
            font-size: clamp(1rem, 3.5vw, 1.5rem);
        }
        
        .tile-1024 .tile-number,
        .tile-2048 .tile-number,
        .tile-4096 .tile-number,
        .tile-8192 .tile-number {
            font-size: clamp(0.8rem, 3vw, 1.2rem);
        }
        
        /* åº•éƒ¨æŒ‰é’®åŒºåŸŸ */
        .button-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            width: 100%;
            margin-top: 15px;
        }
        
        .btn {
            background-color: var(--button-bg);
            color: var(--text-color);
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 0;
            font-size: clamp(0.85rem, 2.5vw, 1rem);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px var(--shadow-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
        }
        
        .btn-restart {
            background-color: var(--restart-bg);
        }
        
        .btn-restart:hover {
            background-color: #c82333;
        }
        
        .night-mode .btn-restart:hover {
            background-color: #f59c6c;
        }
        
        .btn-save {
            background-color: var(--save-bg);
        }
        
        .btn-save:hover {
            background-color: #218838;
        }
        
        .night-mode .btn-save:hover {
            background-color: #219653;
        }
        
        .btn-load {
            background-color: var(--load-bg);
        }
        
        .btn-load:hover {
            background-color: #138496;
        }
        
        .night-mode .btn-load:hover {
            background-color: #42a5f5;
        }
        
        .btn-mode {
            background-color: var(--mode-toggle-bg);
        }
        
        .btn-mode:hover {
            background-color: #e0a800;
        }
        
        .night-mode .btn-mode:hover {
            background-color: #8e44ad;
        }
        
        /* é®ç½©å±‚ */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal {
            background-color: var(--modal-bg);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 400px;
            padding: 25px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            text-align: center;
            transition: background-color 0.3s ease;
        }
        
        .modal-title {
            font-size: clamp(1.5rem, 4vw, 1.8rem);
            color: var(--accent-color);
            margin-bottom: 15px;
        }
        
        .modal-message {
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .btn-modal {
            padding: 10px 25px;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
        }
        
        /* æ“ä½œæç¤º */
        .control-tip {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: #ffffff;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            z-index: 50;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }
        
        .control-tip:hover {
            opacity: 1;
        }
        
        /* èƒœåˆ©æç¤º */
        .win-tip {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--accent-color);
            color: var(--secondary-bg);
            padding: 20px 25px;
            border-radius: var(--border-radius);
            font-size: clamp(1.2rem, 3.5vw, 1.5rem);
            font-weight: bold;
            z-index: 150;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            text-align: center;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        
        .win-tip.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .win-tip p {
            margin-bottom: 15px;
        }
        
        /* ä¿å­˜/åŠ è½½æç¤º */
        .toast {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--grid-bg);
            color: var(--text-color);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: clamp(0.85rem, 2.5vw, 1rem);
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: translate(-50%, 20px);
        }
        
        .toast.active {
            opacity: 1;
            transform: translate(-50%, 0);
        }
        
        .toast-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .toast-error {
            background-color: var(--error-color);
            color: white;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-height: 600px) {
            .button-container {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .btn {
                padding: 10px 0;
                font-size: clamp(0.8rem, 2.5vw, 0.9rem);
            }
            
            .stats-container {
                gap: 8px;
            }
            
            .stat-box {
                padding: 10px 8px;
                min-height: 70px;
            }
            
            .game-title {
                font-size: clamp(2rem, 7vw, 3rem);
            }
        }
        
        @media (max-width: 320px) {
            .grid-inner {
                gap: 8px;
            }
            
            .grid-container {
                padding: 10px;
            }
            
            .tile-container {
                top: 10px;
                left: 10px;
                right: 10px;
                bottom: 10px;
            }
            
            .button-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* PWA ä¸“ç”¨æ ·å¼ */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
            }
            
            .control-tip {
                display: none; /* åœ¨PWAä¸­éšè—æ»‘åŠ¨æç¤º */
            }
        }
    </style>
</head>
<body>
    <!-- PWA å¯åŠ¨ç”»é¢ -->
    <div id="splash-screen">
        <div class="splash-logo">2048</div>
        <div class="splash-loading">
            <div class="splash-spinner"></div>
            <div class="splash-text">åŠ è½½ä¸­...</div>
        </div>
    </div>
    
    <!-- ç¦»çº¿çŠ¶æ€æç¤º -->
    <div id="offline-status">âš¡ ç¦»çº¿æ¨¡å¼</div>
    
    <!-- PWA å®‰è£…æç¤º -->
    <div id="install-prompt">
        <div class="prompt-content">
            <div class="prompt-title">å®‰è£… 2048 æ¸¸æˆ</div>
            <div class="prompt-message">æ·»åŠ åˆ°ä¸»å±å¹•ï¼Œè·å¾—æ›´å¥½çš„æ¸¸æˆä½“éªŒ</div>
        </div>
        <div class="prompt-actions">
            <button class="prompt-btn secondary" id="install-later">ç¨å</button>
            <button class="prompt-btn" id="install-now">å®‰è£…</button>
        </div>
    </div>
    
    <div class="container">
        <!-- é¡¶éƒ¨åŒºåŸŸ -->
        <div class="header">
            <h1 class="game-title">2048</h1>
            <p class="subtitle">æ»‘åŠ¨å±å¹•åˆå¹¶æ–¹å—ï¼ŒæŒ‘æˆ˜é«˜åˆ†ï¼</p>
            <div class="mode-toggle-container">
                <button class="mode-toggle" id="mode-toggle">
                    <span class="mode-icon">ğŸŒ™</span>
                    <span class="mode-label">å¤œé—´æ¨¡å¼</span>
                </button>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯åŒºåŸŸ -->
        <div class="stats-container">
            <div class="stat-box">
                <div class="stat-title">å½“å‰åˆ†æ•°</div>
                <div class="stat-value" id="current-score">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-title">æœ€é«˜åˆ†</div>
                <div class="stat-value" id="high-score">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-title">æœ€å¤§æ–¹å—</div>
                <div class="stat-value" id="max-tile">2</div>
                <div class="merge-record">
                    <span class="merge-highlight" id="last-merge">0</span>
                    <span class="merge-label">ä¸Šæ¬¡åˆå¹¶</span>
                </div>
            </div>
        </div>
        
        <!-- æ¸¸æˆåŒºåŸŸ -->
        <div class="game-area">
            <div class="game-container">
                <div class="grid-container">
                    <div class="grid">
                        <div class="grid-inner" id="grid-inner">
                            <!-- ç½‘æ ¼å•å…ƒæ ¼ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="tile-container" id="tile-container"></div>
                </div>
            </div>
        </div>
        
        <!-- åº•éƒ¨æŒ‰é’®åŒºåŸŸ -->
        <div class="button-container">
            <button class="btn btn-restart" id="restart-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 10h10"></path>
                    <path d="M7 14l5-5 5 5"></path>
                    <path d="M11 2v10"></path>
                </svg>
                é‡æ–°å¼€å§‹
            </button>
            <button class="btn btn-save" id="save-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21H5a2 2 0 0 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                ä¿å­˜æ¸¸æˆ
            </button>
            <button class="btn btn-load" id="load-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                åŠ è½½æ¸¸æˆ
            </button>
            <button class="btn btn-mode" id="mode-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
                åˆ‡æ¢æ¨¡å¼
            </button>
        </div>
    </div>
    
    <!-- æ¸¸æˆç»“æŸé®ç½© -->
    <div class="overlay" id="game-over-overlay">
        <div class="modal">
            <h2 class="modal-title">æ¸¸æˆç»“æŸ!</h2>
            <p class="modal-message">
                æœ€ç»ˆå¾—åˆ†: <span id="final-score">0</span><br>
                æœ€å¤§æ–¹å—: <span id="final-max-tile">2</span>
            </p>
            <div class="modal-actions">
                <button class="btn btn-restart btn-modal" id="game-over-restart">é‡æ–°å¼€å§‹</button>
            </div>
        </div>
    </div>
    
    <!-- èƒœåˆ©æç¤º -->
    <div class="win-tip" id="win-tip">
        <p>æ­å–œä½ åˆæˆäº†2048ï¼</p>
        <button class="btn btn-modal" id="continue-btn">ç»§ç»­æŒ‘æˆ˜</button>
    </div>
    
    <!-- æ“ä½œæç¤º -->
    <div class="control-tip">æ»‘åŠ¨å±å¹•æ§åˆ¶æ–¹å—ç§»åŠ¨</div>
    
    <!-- æç¤ºæ¶ˆæ¯ -->
    <div class="toast" id="toast"></div>

    <script>
        // åˆå§‹åŒ–DOMå…ƒç´ 
        const gridInner = document.getElementById('grid-inner');
        const tileContainer = document.getElementById('tile-container');
        const currentScoreElement = document.getElementById('current-score');
        const highScoreElement = document.getElementById('high-score');
        const maxTileElement = document.getElementById('max-tile');
        const lastMergeElement = document.getElementById('last-merge');
        const restartBtn = document.getElementById('restart-btn');
        const saveBtn = document.getElementById('save-btn');
        const loadBtn = document.getElementById('load-btn');
        const modeToggle = document.getElementById('mode-toggle');
        const modeBtn = document.getElementById('mode-btn');
        const gameOverOverlay = document.getElementById('game-over-overlay');
        const finalScoreElement = document.getElementById('final-score');
        const finalMaxTileElement = document.getElementById('final-max-tile');
        const gameOverRestartBtn = document.getElementById('game-over-restart');
        const winTip = document.getElementById('win-tip');
        const continueBtn = document.getElementById('continue-btn');
        const toast = document.getElementById('toast');
        const splashScreen = document.getElementById('splash-screen');
        const offlineStatus = document.getElementById('offline-status');
        const installPrompt = document.getElementById('install-prompt');
        const installNowBtn = document.getElementById('install-now');
        const installLaterBtn = document.getElementById('install-later');
        const body = document.body;
        
        // æ¸¸æˆçŠ¶æ€å˜é‡
        let board = [];
        let score = 0;
        let highScore = localStorage.getItem('2048-high-score') || 0;
        let maxTile = 2;
        let lastMerge = 0;
        let isGameOver = false;
        let hasWon = false;
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        let isTouching = false;
        
        // PWA å®‰è£…ç›¸å…³å˜é‡
        let deferredPrompt;
        let isStandalone = false;
        
        // æ¨¡å¼ç®¡ç†
        let isNightMode = false;
        
        // ========== PWA åŠŸèƒ½ ==========
        
        // æ£€æŸ¥æ˜¯å¦ä»¥ç‹¬ç«‹åº”ç”¨è¿è¡Œ
        function checkDisplayMode() {
            isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                          window.navigator.standalone === true;
            
            if (isStandalone) {
                console.log('æ­£åœ¨ä»¥PWAç‹¬ç«‹åº”ç”¨æ¨¡å¼è¿è¡Œ');
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ PWAä¸“å±é€»è¾‘
            }
        }
        
        // æ³¨å†Œ Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);
                        
                        // æ£€æŸ¥æ›´æ–°
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('Service Worker æ›´æ–°å‘ç°');
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showToast('æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢è·å–æ›´æ–°', 'success');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('Service Worker æ³¨å†Œå¤±è´¥:', error);
                    });
            }
        }
        
        // ç›‘å¬åœ¨çº¿çŠ¶æ€
        function setupOnlineStatus() {
            window.addEventListener('online', () => {
                offlineStatus.style.display = 'none';
                showToast('å·²æ¢å¤ç½‘ç»œè¿æ¥', 'success');
            });
            
            window.addEventListener('offline', () => {
                offlineStatus.style.display = 'block';
                showToast('å·²è¿›å…¥ç¦»çº¿æ¨¡å¼', 'error');
            });
            
            // åˆå§‹çŠ¶æ€æ£€æŸ¥
            if (!navigator.onLine) {
                offlineStatus.style.display = 'block';
            }
        }
        
        // å¤„ç†PWAå®‰è£…æç¤º
        function setupInstallPrompt() {
            // ç›‘å¬ beforeinstallprompt äº‹ä»¶
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // æ˜¾ç¤ºå®‰è£…æç¤º
                setTimeout(() => {
                    if (!isStandalone && !localStorage.getItem('2048-install-dismissed')) {
                        installPrompt.classList.add('show');
                    }
                }, 5000); // 5ç§’åæ˜¾ç¤º
            });
            
            // å®‰è£…æŒ‰é’®ç‚¹å‡»
            installNowBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        console.log('ç”¨æˆ·æ¥å—äº†å®‰è£…æç¤º');
                        showToast('åº”ç”¨å®‰è£…æˆåŠŸï¼', 'success');
                    } else {
                        console.log('ç”¨æˆ·æ‹’ç»äº†å®‰è£…æç¤º');
                    }
                    
                    deferredPrompt = null;
                    installPrompt.classList.remove('show');
                }
            });
            
            // ç¨åæŒ‰é’®ç‚¹å‡»
            installLaterBtn.addEventListener('click', () => {
                installPrompt.classList.remove('show');
                localStorage.setItem('2048-install-dismissed', 'true');
            });
            
            // å®‰è£…å®Œæˆåéšè—æç¤º
            window.addEventListener('appinstalled', () => {
                console.log('PWA å®‰è£…å®Œæˆ');
                deferredPrompt = null;
                installPrompt.classList.remove('show');
            });
        }
        
        // éšè—å¯åŠ¨ç”»é¢
        function hideSplashScreen() {
            setTimeout(() => {
                splashScreen.classList.add('hidden');
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                }, 500);
            }, 1000); // æ˜¾ç¤º1ç§’åéšè—
        }
        
        // ========== æ¸¸æˆé€»è¾‘ ==========
        
        // åˆå§‹åŒ–æ¨¡å¼
        function initMode() {
            // é»˜è®¤ä½¿ç”¨æ™®é€šæ¨¡å¼
            const savedMode = localStorage.getItem('2048-color-mode');
            if (savedMode === 'night') {
                toggleNightMode();
            }
            updateModeButton();
        }
        
        // åˆ‡æ¢å¤œé—´æ¨¡å¼
        function toggleNightMode() {
            isNightMode = !isNightMode;
            if (isNightMode) {
                body.classList.add('night-mode');
                modeToggle.innerHTML = '<span class="mode-icon">â˜€ï¸</span><span class="mode-label">æ™®é€šæ¨¡å¼</span>';
                localStorage.setItem('2048-color-mode', 'night');
            } else {
                body.classList.remove('night-mode');
                modeToggle.innerHTML = '<span class="mode-icon">ğŸŒ™</span><span class="mode-label">å¤œé—´æ¨¡å¼</span>';
                localStorage.setItem('2048-color-mode', 'day');
            }
            updateModeButton();
        }
        
        // æ›´æ–°åº•éƒ¨æŒ‰é’®çš„å›¾æ ‡
        function updateModeButton() {
            if (isNightMode) {
                modeBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    åˆ‡æ¢æ¨¡å¼
                `;
            } else {
                modeBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    åˆ‡æ¢æ¨¡å¼
                `;
            }
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // åˆ›å»º4x4ç©ºæ£‹ç›˜
            board = Array(4).fill().map(() => Array(4).fill(0));
            score = 0;
            maxTile = 2;
            lastMerge = 0;
            isGameOver = false;
            hasWon = false;
            
            // æ¸…ç©ºç“·ç –å®¹å™¨
            tileContainer.innerHTML = '';
            
            // éšè—æ‰€æœ‰é®ç½©å’Œæç¤º
            gameOverOverlay.classList.remove('active');
            winTip.classList.remove('active');
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤º
            updateStatsDisplay();
            
            // æ·»åŠ ä¸¤ä¸ªåˆå§‹æ–¹å—
            addRandomTile();
            addRandomTile();
            
            // æ¸²æŸ“ç½‘æ ¼å•å…ƒæ ¼
            renderGridCells();
            // æ¸²æŸ“ç“·ç –
            renderTiles();
            
            // æ˜¾ç¤ºæ“ä½œæç¤ºï¼ˆ3ç§’åè‡ªåŠ¨éšè—ï¼‰
            setTimeout(() => {
                if (!isStandalone) {
                    document.querySelector('.control-tip').style.opacity = '0';
                }
            }, 3000);
        }
        
        // æ¸²æŸ“ç½‘æ ¼å•å…ƒæ ¼
        function renderGridCells() {
            gridInner.innerHTML = '';
            for (let y = 0; y < 4; y++) {
                for (let x = 0; x < 4; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    gridInner.appendChild(cell);
                }
            }
        }
        
        // æ¸²æŸ“ç“·ç –
        function renderTiles() {
            tileContainer.innerHTML = '';
            // è®¡ç®—å•å…ƒæ ¼å°ºå¯¸ï¼ˆé€‚é…å“åº”å¼ï¼‰
            const cellWidth = (gridInner.offsetWidth - (10 * 3)) / 4; // 10pxé—´éš™ï¼Œ3ä¸ªé—´éš™
            const cellHeight = (gridInner.offsetHeight - (10 * 3)) / 4;
            
            for (let y = 0; y < 4; y++) {
                for (let x = 0; x < 4; x++) {
                    const value = board[y][x];
                    if (value !== 0) {
                        const tile = document.createElement('div');
                        tile.className = `tile tile-${value}`;
                        
                        // æ·»åŠ æ•°å­—å®¹å™¨
                        const number = document.createElement('div');
                        number.className = 'tile-number';
                        number.textContent = value;
                        tile.appendChild(number);
                        
                        // è®¡ç®—ç“·ç –ä½ç½®
                        const tileX = x * (cellWidth + 10);
                        const tileY = y * (cellHeight + 10);
                        
                        // è®¾ç½®ç“·ç –å°ºå¯¸å’Œä½ç½®
                        tile.style.width = `${cellWidth}px`;
                        tile.style.height = `${cellHeight}px`;
                        tile.style.left = `${tileX}px`;
                        tile.style.top = `${tileY}px`;
                        
                        tileContainer.appendChild(tile);
                    }
                }
            }
        }
        
        // æ·»åŠ éšæœºç“·ç –ï¼ˆ2æˆ–4ï¼‰
        function addRandomTile() {
            const emptyCells = [];
            // æ”¶é›†æ‰€æœ‰ç©ºå•å…ƒæ ¼
            for (let y = 0; y < 4; y++) {
                for (let x = 0; x < 4; x++) {
                    if (board[y][x] === 0) {
                        emptyCells.push({ x, y });
                    }
                }
            }
            
            // å¦‚æœæ²¡æœ‰ç©ºå•å…ƒæ ¼ï¼Œè¿”å›å¤±è´¥
            if (emptyCells.length === 0) return false;
            
            // éšæœºé€‰æ‹©ä¸€ä¸ªç©ºå•å…ƒæ ¼
            const { x, y } = emptyCells[Math.floor(Math.random() * emptyCells.length)];
            // 90%æ¦‚ç‡ç”Ÿæˆ2ï¼Œ10%æ¦‚ç‡ç”Ÿæˆ4
            const value = Math.random() < 0.9 ? 2 : 4;
            board[y][x] = value;
            
            // æ›´æ–°æœ€å¤§æ–¹å—è®°å½•
            if (value > maxTile) maxTile = value;
            
            // åˆ›å»ºæ–°ç“·ç –å…ƒç´ ï¼ˆå¸¦åŠ¨ç”»ï¼‰
            const tile = document.createElement('div');
            tile.className = `tile tile-${value} tile-new`;
            
            const number = document.createElement('div');
            number.className = 'tile-number';
            number.textContent = value;
            tile.appendChild(number);
            
            // è®¡ç®—æ–°ç“·ç –ä½ç½®
            const cellWidth = (gridInner.offsetWidth - (10 * 3)) / 4;
            const cellHeight = (gridInner.offsetHeight - (10 * 3)) / 4;
            const tileX = x * (cellWidth + 10);
            const tileY = y * (cellHeight + 10);
            
            tile.style.width = `${cellWidth}px`;
            tile.style.height = `${cellHeight}px`;
            tile.style.left = `${tileX}px`;
            tile.style.top = `${tileY}px`;
            
            tileContainer.appendChild(tile);
            
            return true;
        }
        
        // ç§»åŠ¨æ–¹å—ï¼ˆæ ¸å¿ƒæ¸¸æˆé€»è¾‘ï¼‰
        function move(direction) {
            if (isGameOver || hasWon) return;
            
            let moved = false;
            let newBoard = JSON.parse(JSON.stringify(board)); // æ·±æ‹·è´æ£‹ç›˜
            
            // æ ¹æ®æ–¹å‘å¤„ç†ç§»åŠ¨å’Œåˆå¹¶
            switch (direction) {
                case 'left':
                    for (let y = 0; y < 4; y++) {
                        // è¿‡æ»¤ç©ºå•å…ƒæ ¼
                        let row = newBoard[y].filter(cell => cell !== 0);
                        // åˆå¹¶ç›¸åŒæ•°å­—
                        for (let x = 0; x < row.length - 1; x++) {
                            if (row[x] === row[x + 1]) {
                                row[x] *= 2;
                                row[x + 1] = 0;
                                score += row[x];
                                lastMerge = row[x];
                                moved = true;
                                
                                // æ›´æ–°æœ€å¤§æ–¹å—
                                if (row[x] > maxTile) maxTile = row[x];
                                // æ£€æŸ¥æ˜¯å¦åˆæˆ2048
                                if (row[x] === 2048 && !hasWon) {
                                    hasWon = true;
                                    setTimeout(() => winTip.classList.add('active'), 200);
                                }
                            }
                        }
                        // å†æ¬¡è¿‡æ»¤ç©ºå•å…ƒæ ¼ï¼ˆåˆå¹¶äº§ç”Ÿçš„ï¼‰
                        row = row.filter(cell => cell !== 0);
                        // è¡¥å……ç©ºå•å…ƒæ ¼åˆ°4ä¸ª
                        while (row.length < 4) row.push(0);
                        newBoard[y] = row;
                    }
                    break;
                    
                case 'right':
                    for (let y = 0; y < 4; y++) {
                        // è¿‡æ»¤ç©ºå•å…ƒæ ¼å¹¶åè½¬ï¼ˆå®ç°å³ç§»ï¼‰
                        let row = newBoard[y].filter(cell => cell !== 0).reverse();
                        // åˆå¹¶ç›¸åŒæ•°å­—
                        for (let x = 0; x < row.length - 1; x++) {
                            if (row[x] === row[x + 1]) {
                                row[x] *= 2;
                                row[x + 1] = 0;
                                score += row[x];
                                lastMerge = row[x];
                                moved = true;
                                
                                if (row[x] > maxTile) maxTile = row[x];
                                if (row[x] === 2048 && !hasWon) {
                                    hasWon = true;
                                    setTimeout(() => winTip.classList.add('active'), 200);
                                }
                            }
                        }
                        // è¿‡æ»¤ç©ºå•å…ƒæ ¼å¹¶æ¢å¤åŸé¡ºåº
                        row = row.filter(cell => cell !== 0).reverse();
                        // è¡¥å……ç©ºå•å…ƒæ ¼åˆ°4ä¸ª
                        while (row.length < 4) row.unshift(0);
                        newBoard[y] = row;
                    }
                    break;
                    
                case 'up':
                    for (let x = 0; x < 4; x++) {
                        // æå–å½“å‰åˆ—éç©ºå•å…ƒæ ¼
                        let col = [];
                        for (let y = 0; y < 4; y++) {
                            if (newBoard[y][x] !== 0) col.push(newBoard[y][x]);
                        }
                        // åˆå¹¶ç›¸åŒæ•°å­—
                        for (let y = 0; y < col.length - 1; y++) {
                            if (col[y] === col[y + 1]) {
                                col[y] *= 2;
                                col[y + 1] = 0;
                                score += col[y];
                                lastMerge = col[y];
                                moved = true;
                                
                                if (col[y] > maxTile) maxTile = col[y];
                                if (col[y] === 2048 && !hasWon) {
                                    hasWon = true;
                                    setTimeout(() => winTip.classList.add('active'), 200);
                                }
                            }
                        }
                        // è¿‡æ»¤ç©ºå•å…ƒæ ¼
                        col = col.filter(cell => cell !== 0);
                        // è¡¥å……ç©ºå•å…ƒæ ¼åˆ°4ä¸ª
                        while (col.length < 4) col.push(0);
                        // æ›´æ–°å½“å‰åˆ—æ•°æ®
                        for (let y = 0; y < 4; y++) {
                            newBoard[y][x] = col[y];
                        }
                    }
                    break;
                    
                case 'down':
                    for (let x = 0; x < 4; x++) {
                        // æå–å½“å‰åˆ—éç©ºå•å…ƒæ ¼å¹¶åè½¬ï¼ˆå®ç°ä¸‹ç§»ï¼‰
                        let col = [];
                        for (let y = 0; y < 4; y++) {
                            if (newBoard[y][x] !== 0) col.push(newBoard[y][x]);
                        }
                        col = col.reverse();
                        // åˆå¹¶ç›¸åŒæ•°å­—
                        for (let y = 0; y < col.length - 1; y++) {
                            if (col[y] === col[y + 1]) {
                                col[y] *= 2;
                                col[y + 1] = 0;
                                score += col[y];
                                lastMerge = col[y];
                                moved = true;
                                
                                if (col[y] > maxTile) maxTile = col[y];
                                if (col[y] === 2048 && !hasWon) {
                                    hasWon = true;
                                    setTimeout(() => winTip.classList.add('active'), 200);
                                }
                            }
                        }
                        // è¿‡æ»¤ç©ºå•å…ƒæ ¼å¹¶æ¢å¤åŸé¡ºåº
                        col = col.filter(cell => cell !== 0).reverse();
                        // è¡¥å……ç©ºå•å…ƒæ ¼åˆ°4ä¸ª
                        while (col.length < 4) col.unshift(0);
                        // æ›´æ–°å½“å‰åˆ—æ•°æ®
                        for (let y = 0; y < 4; y++) {
                            newBoard[y][x] = col[y];
                        }
                    }
                    break;
            }
            
            // å¦‚æœæœ‰ç§»åŠ¨ï¼Œæ›´æ–°æ£‹ç›˜å¹¶æ·»åŠ æ–°ç“·ç –
            if (JSON.stringify(board) !== JSON.stringify(newBoard)) {
                board = newBoard;
                moved = true;
                // æ¸²æŸ“ç“·ç –ï¼ˆå¸¦ç§»åŠ¨åŠ¨ç”»ï¼‰
                renderTiles();
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateStatsDisplay();
                
                // å»¶è¿Ÿæ·»åŠ æ–°ç“·ç –ï¼ˆä¼˜åŒ–åŠ¨ç”»ä½“éªŒï¼‰
                setTimeout(() => {
                    addRandomTile();
                    // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
                    if (!canMove()) {
                        isGameOver = true;
                        finalScoreElement.textContent = score;
                        finalMaxTileElement.textContent = maxTile;
                        setTimeout(() => gameOverOverlay.classList.add('active'), 200);
                    }
                }, 120);
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦è¿˜èƒ½ç§»åŠ¨ï¼ˆæ¸¸æˆç»“æŸåˆ¤æ–­ï¼‰
        function canMove() {
            // æ£€æŸ¥æ˜¯å¦æœ‰ç©ºä½
            for (let y = 0; y < 4; y++) {
                for (let x = 0; x < 4; x++) {
                    if (board[y][x] === 0) return true;
                }
            }
            
            // æ£€æŸ¥æ¨ªå‘æ˜¯å¦æœ‰å¯åˆå¹¶çš„æ–¹å—
            for (let y = 0; y < 4; y++) {
                for (let x = 0; x < 3; x++) {
                    if (board[y][x] === board[y][x + 1]) return true;
                }
            }
            
            // æ£€æŸ¥çºµå‘æ˜¯å¦æœ‰å¯åˆå¹¶çš„æ–¹å—
            for (let x = 0; x < 4; x++) {
                for (let y = 0; y < 3; y++) {
                    if (board[y][x] === board[y + 1][x]) return true;
                }
            }
            
            return false; // æ— ç©ºä½ä¸”æ— å¯åˆå¹¶ï¼Œæ¸¸æˆç»“æŸ
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤º
        function updateStatsDisplay() {
            currentScoreElement.textContent = score;
            // æ›´æ–°æœ€é«˜åˆ†ï¼ˆæœ¬åœ°å­˜å‚¨æŒä¹…åŒ–ï¼‰
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('2048-high-score', highScore);
            }
            highScoreElement.textContent = highScore;
            maxTileElement.textContent = maxTile;
            lastMergeElement.textContent = lastMerge || '-';
        }
        
        // ä¿å­˜æ¸¸æˆçŠ¶æ€
        function saveGame() {
            const gameState = {
                board: board,
                score: score,
                maxTile: maxTile,
                lastMerge: lastMerge,
                hasWon: hasWon,
                isNightMode: isNightMode // ä¿å­˜å½“å‰æ¨¡å¼
            };
            
            try {
                localStorage.setItem('2048-game-state', JSON.stringify(gameState));
                showToast('æ¸¸æˆä¿å­˜æˆåŠŸ', 'success');
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                console.error('ä¿å­˜æ¸¸æˆå¤±è´¥:', e);
            }
        }
        
        // åŠ è½½æ¸¸æˆçŠ¶æ€
        function loadGame() {
            const savedState = localStorage.getItem('2048-game-state');
            
            if (!savedState) {
                showToast('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ¸¸æˆ', 'error');
                return;
            }
            
            try {
                const gameState = JSON.parse(savedState);
                board = gameState.board;
                score = gameState.score;
                maxTile = gameState.maxTile;
                lastMerge = gameState.lastMerge;
                hasWon = gameState.hasWon;
                isGameOver = false;
                
                // æ¢å¤ä¿å­˜æ—¶çš„æ¨¡å¼
                if (gameState.isNightMode && !isNightMode) {
                    toggleNightMode();
                } else if (!gameState.isNightMode && isNightMode) {
                    toggleNightMode();
                }
                
                // æ›´æ–°æ˜¾ç¤º
                updateStatsDisplay();
                renderTiles();
                
                showToast('æ¸¸æˆåŠ è½½æˆåŠŸ', 'success');
            } catch (e) {
                showToast('åŠ è½½å¤±è´¥ï¼Œå­˜æ¡£å·²æŸå', 'error');
                console.error('åŠ è½½æ¸¸æˆå¤±è´¥:', e);
            }
        }
        
        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'default') {
            toast.textContent = message;
            toast.className = 'toast';
            if (type === 'success') {
                toast.classList.add('toast-success');
            } else if (type === 'error') {
                toast.classList.add('toast-error');
            }
            
            toast.classList.add('active');
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }
        
        // å¤„ç†æ»‘åŠ¨äº‹ä»¶
        function handleSwipe() {
            const dx = touchEndX - touchStartX; // æ°´å¹³åç§»
            const dy = touchEndY - touchStartY; // å‚ç›´åç§»
            const threshold = 30; // æ»‘åŠ¨æœ€å°è·ç¦»ï¼ˆä¼˜åŒ–æ‰‹æœºè¯¯è§¦ï¼‰
            const swipeAngle = Math.atan2(Math.abs(dy), Math.abs(dx)) * 180 / Math.PI;
            
            // æ°´å¹³æ»‘åŠ¨ï¼ˆå·¦å³ï¼‰
            if (swipeAngle < 45) {
                if (dx > threshold) {
                    move('right');
                } else if (dx < -threshold) {
                    move('left');
                }
            } 
            // å‚ç›´æ»‘åŠ¨ï¼ˆä¸Šä¸‹ï¼‰
            else if (swipeAngle > 45) {
                if (dy > threshold) {
                    move('down');
                } else if (dy < -threshold) {
                    move('up');
                }
            }
        }
        
        // ========== äº‹ä»¶ç›‘å¬ ==========
        
        // è§¦æ‘¸äº‹ä»¶ç›‘å¬
        document.addEventListener('touchstart', (e) => {
            if (isGameOver) return;
            
            isTouching = true;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }, { passive: true });
        
        document.addEventListener('touchmove', (e) => {
            if (!isTouching || isGameOver) return;
            
            touchEndX = e.touches[0].clientX;
            touchEndY = e.touches[0].clientY;
        }, { passive: true });
        
        document.addEventListener('touchend', (e) => {
            if (!isTouching || isGameOver) return;
            
            isTouching = false;
            handleSwipe();
        }, { passive: true });
        
        // é”®ç›˜æ§åˆ¶ï¼ˆç”µè„‘ç«¯è°ƒè¯•ç”¨ï¼‰
        document.addEventListener('keydown', (e) => {
            switch (e.key) {
                case 'ArrowUp': move('up'); break;
                case 'ArrowDown': move('down'); break;
                case 'ArrowLeft': move('left'); break;
                case 'ArrowRight': move('right'); break;
                case 'r': case 'R': initGame(); break; // å¿«æ·é”®ï¼šRé‡æ–°å¼€å§‹
                case 's': case 'S': saveGame(); break; // å¿«æ·é”®ï¼šSä¿å­˜
                case 'l': case 'L': loadGame(); break; // å¿«æ·é”®ï¼šLåŠ è½½
                case 'm': case 'M': toggleNightMode(); break; // å¿«æ·é”®ï¼šMåˆ‡æ¢æ¨¡å¼
            }
        });
        
        // æŒ‰é’®äº‹ä»¶ç›‘å¬
        restartBtn.addEventListener('click', initGame);
        saveBtn.addEventListener('click', saveGame);
        loadBtn.addEventListener('click', loadGame);
        modeToggle.addEventListener('click', toggleNightMode);
        modeBtn.addEventListener('click', toggleNightMode);
        gameOverRestartBtn.addEventListener('click', initGame);
        continueBtn.addEventListener('click', () => {
            winTip.classList.remove('active');
            hasWon = false; // è§£é™¤èƒœåˆ©é”å®šï¼Œç»§ç»­æŒ‘æˆ˜
        });
        
        // ========== åˆå§‹åŒ– ==========
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
        window.addEventListener('load', () => {
            // åˆå§‹åŒ–PWAåŠŸèƒ½
            checkDisplayMode();
            registerServiceWorker();
            setupOnlineStatus();
            setupInstallPrompt();
            hideSplashScreen();
            
            // åˆå§‹åŒ–æ¸¸æˆåŠŸèƒ½
            initMode();
            initGame();
        });
        
        // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“ï¼ˆé€‚é…æ—‹è½¬å±å¹•ï¼‰
        window.addEventListener('resize', () => {
            if (!isGameOver) {
                renderTiles();
            }
        });
        
        // é˜²æ­¢é¡µé¢æ»šåŠ¨
        document.addEventListener('touchmove', (e) => {
            if (e.target.closest('.game-container')) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // ç¦ç”¨åŒå‡»ç¼©æ”¾
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, { passive: false });
    </script>
</body>
</html>